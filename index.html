<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector Versi√≥n 4.0</title> <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f2f5;
            text-align: center;
            padding: 20px;
            color: #333;
        }
        h1 { margin-bottom: 10px; }
        .video-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border: 5px solid #fff;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            overflow: hidden;
            background: #000;
        }
        video { width: 100%; display: block; }
        button {
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 18px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
        }
        button:disabled { background-color: #ccc; }
        #resultado {
            margin-top: 20px;
            font-size: 20px;
            font-weight: bold;
            padding: 15px;
            background: white;
            border-radius: 10px;
            display: inline-block;
            word-wrap: break-word;
        }
    </style>
</head>
<body>

    <h1>üê∂ vs üê± (V4.0)</h1>

    <div class="video-container">
        <video id="webcam" autoplay playsinline muted></video>
    </div>

    <div id="resultado">Cargando modelo... ‚è≥</div>
    <br>
    <button id="btn-camara" onclick="iniciarCamara()" disabled>Iniciar C√°mara</button>

    <script>
        let modelo = null;
        const video = document.getElementById('webcam');
        const resultadoDiv = document.getElementById('resultado');
        const btnCamara = document.getElementById('btn-camara');

        (async () => {
            try {
                console.log("Intentando cargar modelo...");
                
                // --- CAMBIO IMPORTANTE AQU√ç ---
                // Cambiamos loadLayersModel por loadGraphModel
                modelo = await tf.loadGraphModel('./model.json'); 
                
                console.log("Modelo cargado exitosamente");
                resultadoDiv.innerText = "Modelo cargado. ¬°Listo!";
                btnCamara.disabled = false;
            } catch (error) {
                console.error("Error detallado:", error);
                resultadoDiv.innerText = "FALLO: " + error.message;
                resultadoDiv.style.color = "red";
            }
        })();

        async function iniciarCamara() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
                btnCamara.style.display = "none";
                video.onloadedmetadata = () => {
                    predecirEnTiempoReal();
                };
            } catch (err) {
                alert("Error c√°mara: " + err.message);
            }
        }

        async function predecirEnTiempoReal() {
            if (modelo) {
                tf.tidy(() => {
                    // Preprocesamiento (100x100, B/N, Normalizado)
                    let img = tf.browser.fromPixels(video)
                        .resizeNearestNeighbor([100, 100])
                        .mean(2)
                        .expandDims(2)
                        .expandDims()
                        .toFloat()
                        .div(255.0);

                    // Para GraphModel, a veces predict funciona igual, a veces requiere execute.
                    // Probamos con predict primero que es lo est√°ndar.
                    const prediccion = modelo.predict(img).dataSync();
                    
                    // Como tu salida es Sigmoid (0 a 1), es un solo n√∫mero
                    const resultado = prediccion[0];

                    if (resultado >= 0.5) {
                        resultadoDiv.innerText = "üê∂ PERRO (" + resultado.toFixed(2) + ")";
                        resultadoDiv.style.color = "blue";
                    } else {
                        resultadoDiv.innerText = "üê± GATO (" + resultado.toFixed(2) + ")";
                        resultadoDiv.style.color = "green";
                    }
                });
            }
            requestAnimationFrame(predecirEnTiempoReal);
        }
    </script>
</body>
</html>