<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector V7.0 (Dos Pasos)</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    
    <style>
        body { font-family: sans-serif; background: #222; text-align: center; color: white; }
        h1 { margin: 10px; font-size: 20px; }
        
        .video-container {
            width: 90%; max-width: 400px; margin: 10px auto;
            border: 3px solid #fff; border-radius: 10px;
            background: #000; height: 300px; position: relative;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Botones grandes para dedos */
        .btn {
            padding: 15px 30px; font-size: 18px;
            border: none; border-radius: 10px; cursor: pointer;
            font-weight: bold; margin: 10px; width: 80%;
        }
        .btn-green { background-color: #28a745; color: white; }
        .btn-blue { background-color: #007bff; color: white; display: none; } /* Oculto al inicio */
        
        #resultado { 
            font-size: 24px; font-weight: bold; color: yellow; 
            margin: 15px; min-height: 30px; 
            background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;
        }
        #debug { font-size: 12px; color: #aaa; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>üê∂ vs üê± (V5.0)</h1>

    <div class="video-container">
        <video id="webcam" autoplay playsinline muted></video>
    </div>

    <div id="resultado">Paso 1: Enciende la c√°mara</div>
    
    <button id="btn-camara" class="btn btn-green" onclick="encenderCamara()">1. Encender C√°mara</button>
    
    <button id="btn-ia" class="btn btn-blue" onclick="comenzarPrediccion()">2. Activar Cerebro IA</button>

    <div id="debug">Esperando...</div>

    <script>
        let modelo = null;
        let camaraActiva = false;
        const video = document.getElementById('webcam');
        const resultadoDiv = document.getElementById('resultado');
        const debugDiv = document.getElementById('debug');
        const btnCamara = document.getElementById('btn-camara');
        const btnIA = document.getElementById('btn-ia');

        // Cargar modelo al iniciar la p√°gina
        (async () => {
            try {
                debugDiv.innerText = "Cargando modelo...";
                modelo = await tf.loadGraphModel('./model.json'); 
                debugDiv.innerText = "Modelo cargado en memoria ‚úÖ";
            } catch (error) {
                debugDiv.innerText = "Error cargando modelo: " + error.message;
            }
        })();

        // PASO 1: SOLO ENCENDER C√ÅMARA (Sin IA)
        async function encenderCamara() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" },
                    audio: false
                });
                video.srcObject = stream;
                video.play();
                camaraActiva = true;
                
                // Si la c√°mara funciona, ocultamos bot√≥n 1 y mostramos bot√≥n 2
                btnCamara.style.display = "none";
                btnIA.style.display = "inline-block";
                resultadoDiv.innerText = "¬°C√°mara lista! Ahora activa la IA üëá";
                
            } catch (err) {
                alert("Error c√°mara: " + err.message);
            }
        }

        // PASO 2: ACTIVAR PREDICCI√ìN
        function comenzarPrediccion() {
            if (!modelo) {
                alert("El modelo aun no carga. Espera 5 segundos.");
                return;
            }
            if (!camaraActiva) {
                alert("Primero enciende la c√°mara.");
                return;
            }
            
            resultadoDiv.innerText = "üß† Pensando...";
            btnIA.style.display = "none"; // Ocultar bot√≥n para que no estorbe
            predecirLoop();
        }

        async function predecirLoop() {
            try {
                tf.tidy(() => {
                    // 1. Captura
                    let img = tf.browser.fromPixels(video);
                    
                    // 2. Ajustes (100x100, Blanco y Negro)
                    img = tf.image.resizeNearestNeighbor(img, [100, 100]);
                    img = tf.image.rgbToGrayscale(img); 
                    img = img.expandDims().toFloat(); // (1, 100, 100, 1)

                    // 3. Predecir
                    // IMPORTANTE: Si se traba aqu√≠, es que el modelo es muy pesado para el celular
                    const prediccion = modelo.predict(img).dataSync();
                    const valor = prediccion[0];

                    // 4. Mostrar
                    if (valor >= 0.5) {
                        resultadoDiv.innerText = "üê∂ PERRO (" + valor.toFixed(2) + ")";
                        resultadoDiv.style.color = "#00BFFF"; // Azul claro
                    } else {
                        resultadoDiv.innerText = "üê± GATO (" + valor.toFixed(2) + ")";
                        resultadoDiv.style.color = "#90EE90"; // Verde claro
                    }
                });
                
                // Ciclo infinito suave
                requestAnimationFrame(predecirLoop);
                
            } catch (err) {
                debugDiv.innerText = "Error al predecir: " + err.message;
            }
        }
    </script>
</body>
</html>